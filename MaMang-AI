import requests, time, json

# --- TOKEN ---
# Token Telegram Bot (dari BotFather, format: 123456:ABCxxxx)
BOT_TOKEN = "8165865010:AAGFZfe8v6AnszDDIULDDb5Xq3nSCVuxowo"

# Token AgentRouter (format: sk-xxxxxx)
AGENT_API_TOKEN = "sk-9CXuhqe2DNZEe8QZiDCxbY4tdufLQBkw9ZYi1HBv3XnUJbIr"

# Endpoint AgentRouter (Chat Completions API compatible)
AGENT_API_URL = "https://agentrouter.org/v1/chat/completions"

# --- FUNGSI TELEGRAM ---
def get_updates(offset=None):
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/getUpdates"
    return requests.get(url, params={"timeout": 100, "offset": offset}).json()

def send_message(chat_id, text, buttons=None):
    url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
    payload = {"chat_id": chat_id, "text": text}
    if buttons:
        keyboard = {
            "keyboard": [[{"text": b} for b in buttons]],
            "resize_keyboard": True
        }
        payload["reply_markup"] = json.dumps(keyboard)
    requests.post(url, data=payload)

# --- FUNGSI AGENTROUTER ---
def ask_agentrouter(prompt):
    headers = {
        "Authorization": f"Bearer {AGENT_API_TOKEN}",
        "Content-Type": "application/json"
    }
    body = {
        "model": "gpt-5",
        "messages": [{"role": "user", "content": prompt}]
    }
    r = requests.post(AGENT_API_URL, headers=headers, json=body)
    if r.status_code == 200:
        try:
            data = r.json()
            return data["choices"][0]["message"]["content"]
        except Exception as e:
            return f"⚠️ Error parsing response: {e}\n{r.text}"
    else:
        return f"⚠️ Error {r.status_code}: {r.text}"

# --- LOOP UTAMA ---
def main():
    offset = None
    while True:
        updates = get_updates(offset)
        if "result" in updates:
            for update in updates["result"]:
                offset = update["update_id"] + 1
                if "message" in update and "text" in update["message"]:
                    chat_id = update["message"]["chat"]["id"]
                    text = update["message"]["text"]

                    # kirim ke AgentRouter
                    reply = ask_agentrouter(text)

                    # balas ke Telegram
                    send_message(chat_id, reply)
        time.sleep(1)

if __name__ == "__main__":
    main()
